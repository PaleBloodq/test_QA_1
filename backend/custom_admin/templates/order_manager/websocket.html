<script>
  const managerId = {{ user.id }};

  function makeButtonActive(id) {
    const buttons = [
      'orders-list-button-all',
      'orders-list-button-my',
      'orders-list-button-completed'
    ];

    buttons.forEach(buttonId => {
      const button = document.getElementById(buttonId);
      button.classList.toggle('bg-blue-300', buttonId === id);
    });

    if(id==='accept-order-button') {
      document.getElementById('accept-order-button').classList.add('bg-violet-300')
    }
  }

  function createOrderButton(order) {
    const button = document.createElement('button');
    button.className = 'p-2 mb-2 bg-white border border-gray-300 rounded flex gap-2 items-center select-text flex-wrap';

    const dateParagraph = document.createElement('p');
    dateParagraph.className = 'text-gray-500 text-md';
    dateParagraph.textContent = order.date;

    const statusParagraph = document.createElement('p');
    statusParagraph.textContent = `Статус: ${order.status}`;

    const idParagraph = document.createElement('p');
    idParagraph.textContent = `ID: ${order.telegram_id}`;

    const lastMessageParagraph = document.createElement('p');
    lastMessageParagraph.textContent = order.last_message;

    button.append(dateParagraph, statusParagraph, idParagraph, lastMessageParagraph);

    return button;
  }

  function updateOrdersList(orders) {
    const ordersList = document.getElementById('orders-list');
    ordersList.innerHTML = '';

    orders.forEach(order => {
      const button = createOrderButton(order);
      ordersList.appendChild(button);
    });
  }

  function addNewOrder(order) {
    const ordersList = document.getElementById('orders-list');
    const button = createOrderButton(order);
    ordersList.appendChild(button);
  }

  if (!window.hasInitializedSocket) {
    const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
    const socket = new WebSocket(`${wsProtocol}//${window.location.host}{{ FORCE_SCRIPT_NAME }}/ws/order_manager/`);

    window.addEventListener('load', () => {
     getAllOrders()
    })

    socket.onmessage = function (event) {
      const data = JSON.parse(event.data);
      console.log(data)
      if (data.type === 'all_orders') {
        updateOrdersList(data.orders);
      } else if (data.type === 'new_order') {
        addNewOrder(data.order);
      }
    };

    function getAllOrders() {
      socket.send(JSON.stringify({ type: "all_orders_tab", limit: 20, offset: 0 }));
      makeButtonActive('orders-list-button-all');
    }

    function getMyOrders() {
      socket.send(JSON.stringify({ type: "my_orders_tab", limit: 20, offset: 0 }));
      makeButtonActive('orders-list-button-my');
    }

    function getOrder(event) {
      const id = event.target.id
    }

    function acceptOrder(orderId) {
      // socket.send(JSON.stringify({type: "accept_order", order_id: "ff17dd02-982e-4a7f-a2a5-509ec05ebd72"}));
      makeButtonActive('accept-order-button');
    }

    window.hasInitializedSocket = true;
  }
</script>




<!-- socket.send('{"type": "my_orders_tab", "limit": 20, "offset": 0}');
socket.send('{"type": "all_orders_tab", "limit": 20, "offset": 0}');
{% comment %} socket.send('{"type": "get_order", "order_id": "ff17dd02-982e-4a7f-a2a5-509ec05ebd72"}'); {% endcomment %}
socket.send('{"type": "accept_order", "order_id": "ff17dd02-982e-4a7f-a2a5-509ec05ebd72"}');
{% comment %} socket.send('{"type": "order_completed", "order_id": "ff17dd02-982e-4a7f-a2a5-509ec05ebd72"}'); {% endcomment %}
{% comment %} socket.send('{"type": "new_message", "order_id": "ff17dd02-982e-4a7f-a2a5-509ec05ebd72", "text": "Тестовое сообщение через сокеты", "manager": null}'); {% endcomment %} -->